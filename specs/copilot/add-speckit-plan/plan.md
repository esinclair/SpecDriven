# Implementation Plan: User Management API System

**Branch**: `copilot/add-speckit-plan` | **Date**: 2025-12-30 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/copilot/add-speckit-plan/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following the OpenAPI-first development workflow.

## Summary

This plan describes the implementation approach for a production-ready User Management REST API demonstrating OpenAPI-first development with Spring Boot 3.5.9 and JDK 17. The system provides complete user lifecycle management (CRUD operations), role-based access control, JWT bearer token authentication, feature flag support, and comprehensive error handling with stable error codes and HTTP-based retry semantics. All functionality is gated by feature flags for safe incremental deployment.

## Technical Context

**Language/Version**: Java 17 (JDK 17 with Spring Boot 3.5.9)  
**Primary Dependencies**: Spring Boot 3.5.9, Spring Web, Spring Data JDBC, Spring Security, Spring Validation, JWT (jjwt 0.12.6), Flyway, OpenAPI Generator 7.10.0  
**Storage**: H2 in-memory database (SQL-compliant mode), Spring Data JDBC repositories  
**Testing**: JUnit 5, Spring Boot Test, Mockito, Spring Security Test  
**Target Platform**: JVM-based server (development: embedded Tomcat; production: containerized or standalone JAR)  
**Project Type**: Single Spring Boot web application (backend REST API)  
**Performance Goals**: ≤1s response time for 95% of synchronous operations (health check, login, CRUD operations, paginated list)  
**Constraints**: 
  - OpenAPI contract is source of truth; all API code generated
  - Error codes must be stable; retry semantics conveyed via HTTP status codes only (no `retryable` field)
  - No explicit API versioning (no `/v1`, headers, query params)
  - All changes must be backward compatible and additive
  - Feature flags control all user management endpoints via `FeatureFlag.usersApi`
  - Pagination required for all collection endpoints
**Scale/Scope**: Single-tenant monolithic application supporting hundreds of users with in-memory database for development and testing

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Initial Evaluation (Pre-Research)

✅ **Tests are mandatory**: Plan includes comprehensive test strategy:
   - Unit tests for service layer logic (validation, business rules)
   - Integration tests using Spring Boot Test for full request-response flows
   - Negative tests for validation failures, authentication errors, not found scenarios, conflicts, and transient failures
   - Test coverage for feature flag enabled/disabled states

✅ **Spring-first development**: All components use Spring capabilities:
   - @RestController + @RequestMapping for HTTP endpoints
   - @ControllerAdvice for centralized error handling (stable error codes)
   - @Valid + Bean Validation annotations for request validation
   - Spring Data JDBC repositories for database access
   - Spring Security with JWT for authentication
   - @Value for feature flag injection
   - No custom DI, validation, or error handling frameworks

✅ **Performance budget**: All synchronous operations designed to meet ≤1s response goal:
   - Health check: No database dependency, instant response
   - Login: Single database query + JWT generation (fast in-memory operations)
   - User CRUD: Single-row operations with indexed lookups by UUID primary key
   - List users: Paginated queries with LIMIT/OFFSET, maximum page size enforced (100 items)
   - No complex joins or aggregations in critical path
   - H2 in-memory database ensures sub-millisecond query times

✅ **Paged results**: List users endpoint requires mandatory pagination parameters:
   - `page` (1-based, minimum 1) - REQUIRED query parameter
   - `pageSize` (minimum 1, maximum 100) - REQUIRED query parameter
   - Response includes pagination metadata: `totalCount`, `page`, `pageSize`, `totalPages`
   - OpenAPI contract explicitly defines pagination parameters and response structure

✅ **Error contract**: Comprehensive error handling with stable codes:
   - All errors return `ErrorResponse` schema with `code` (string) and `message` (string) fields
   - Error codes: `VALIDATION_FAILED`, `RESOURCE_NOT_FOUND`, `CONFLICT`, `AUTHENTICATION_REQUIRED`, `AUTHENTICATION_FAILED`, `INTERNAL_ERROR`, `SERVICE_UNAVAILABLE`
   - HTTP status semantics:
     - 400 = validation errors (don't retry)
     - 401 = authentication errors (don't retry without valid credentials)
     - 404 = resource not found (don't retry)
     - 409 = conflict (don't retry without changing request)
     - 500 = internal error (may retry with backoff)
     - 503 = service unavailable (retry with exponential backoff; Retry-After header when available)
   - No `retryable` field in error responses

✅ **Public API compatibility**: No versioning; only additive changes:
   - No `/v1` or version path segments in URLs
   - No version headers or query parameters
   - Existing operations: all inputs are explicitly defined; no new required inputs added
   - Future evolution: only optional inputs and optional output fields may be added
   - Breaking changes prohibited by constitution

✅ **Feature flagging**: All user management endpoints gated:
   - Feature flag name: `FeatureFlag.usersApi` (Spring boolean property)
   - Default value: `false` (disabled until validated)
   - Flag controls: `/users/*`, `/login` endpoints
   - Health check `/ping` explicitly NOT gated (always available)
   - When disabled: endpoints return 404 with standard error body (no feature disclosure)
   - Tests cover both enabled and disabled states

✅ **Build gate**: `./gradlew clean build` is the definition of done:
   - All tests must pass
   - OpenAPI generation must succeed
   - Application must start successfully
   - No compilation errors or warnings

### Post-Design Evaluation

✅ **Tests are mandatory**: VERIFIED
   - Complete test strategy defined in plan
   - Unit tests for service layer, mappers, security components
   - Integration tests for full request-response flows
   - Test coverage includes happy paths + negative cases + edge cases
   - Performance tests validate ≤1s budget
   - All test types documented with naming conventions

✅ **Spring-first development**: VERIFIED
   - OpenAPI contract defines all API endpoints and models
   - Generated code uses Spring annotations (@RestController, @RequestMapping, etc.)
   - Controllers implement generated API interfaces
   - Services use Spring Data JDBC repositories
   - Security uses Spring Security with JWT filter
   - Validation uses Bean Validation annotations
   - Error handling via @ControllerAdvice
   - Feature flags via Spring @Value
   - No custom frameworks or bypassing Spring capabilities

✅ **Performance budget**: VERIFIED
   - Health check: no DB, instant response < 1s
   - Login: single user lookup by username (indexed) + JWT generation < 1s
   - User CRUD: single-row operations with UUID PK index < 1s
   - List: pagination with max 100 items, indexed queries < 1s
   - All operations use H2 in-memory for fast queries
   - No N+1 queries, no complex joins in critical paths

✅ **Paged results**: VERIFIED
   - GET /users endpoint requires `page` and `pageSize` query params (both REQUIRED)
   - OpenAPI contract defines pagination parameters with min/max constraints
   - Response schema includes pagination metadata: `totalCount`, `page`, `pageSize`, `totalPages`
   - Page validation enforced: page ≥ 1, pageSize ≥ 1 and ≤ 100
   - Empty results return valid pagination metadata, not errors

✅ **Error contract**: VERIFIED
   - OpenAPI contract defines `ErrorResponse` schema with `code` and `message` fields
   - Stable error codes documented in contract enum
   - @ControllerAdvice maps exceptions to appropriate HTTP status codes
   - No `retryable` field in error responses
   - Retry semantics conveyed by HTTP status code class (4xx vs 5xx)
   - Standard headers (Retry-After) used when applicable for 503 responses

✅ **Public API compatibility**: VERIFIED
   - OpenAPI contract has no version indicators in paths, headers, or query params
   - All endpoints use root paths: /ping, /login, /users, /users/{userId}, etc.
   - All request parameters are explicitly defined (no surprises)
   - No new required inputs added to existing operations
   - Response fields are additive only
   - OpenAPI contract serves as change control mechanism

✅ **Feature flagging**: VERIFIED
   - `FeatureFlag.usersApi` boolean property gates all user management endpoints
   - Default: false (disabled until validated)
   - Health check /ping is NOT gated (always available)
   - When disabled: endpoints return 404 with standard ErrorResponse (no feature disclosure)
   - Implementation: filter/interceptor checks flag before processing requests
   - Tests cover both enabled and disabled states

✅ **Build gate**: VERIFIED
   - `./gradlew clean build` runs OpenAPI generation, compilation, and all tests
   - CI/CD requires green build before merge
   - Build failure on any test failure, compilation error, or OpenAPI generation issue

## Project Structure

### Documentation (this feature)

```text
specs/copilot/add-speckit-plan/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
│   └── user-management-api.yaml  # OpenAPI 3.0.1 specification
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── main/
│   ├── java/com/specdriven/
│   │   ├── SpecDrivenApplication.java          # Spring Boot main class
│   │   ├── config/                              # Configuration classes
│   │   │   ├── SecurityConfig.java              # Spring Security configuration
│   │   │   ├── JwtConfig.java                   # JWT properties and beans
│   │   │   └── OpenApiConfig.java               # OpenAPI documentation config
│   │   ├── controller/                          # REST controllers (implement generated API interfaces)
│   │   │   ├── HealthController.java            # Health check endpoint
│   │   │   ├── AuthController.java              # Login endpoint
│   │   │   ├── UsersApiController.java          # User CRUD endpoints (implements generated UsersApi)
│   │   │   └── RolesApiController.java          # Role assignment endpoints (implements generated RolesApi)
│   │   ├── service/                             # Business logic layer
│   │   │   ├── UserService.java                 # User management business logic
│   │   │   ├── RoleService.java                 # Role management business logic
│   │   │   └── AuthService.java                 # Authentication logic
│   │   ├── repository/                          # Spring Data JDBC repositories
│   │   │   ├── UserRepository.java              # User entity repository
│   │   │   ├── RoleRepository.java              # Role entity repository
│   │   │   └── UserRoleRepository.java          # UserRole join table repository
│   │   ├── entity/                              # Database entities
│   │   │   ├── User.java                        # User entity (@Table("users"))
│   │   │   ├── Role.java                        # Role entity (@Table("roles"))
│   │   │   └── UserRole.java                    # UserRole entity (@Table("user_roles"))
│   │   ├── mapper/                              # Entity ↔ DTO mappers
│   │   │   ├── UserMapper.java                  # User entity ↔ UserResponse/CreateUserRequest
│   │   │   └── RoleMapper.java                  # Role entity ↔ Role DTOs
│   │   ├── security/                            # Security components
│   │   │   ├── JwtTokenProvider.java            # JWT token generation and validation
│   │   │   ├── JwtAuthenticationFilter.java     # JWT filter for protected endpoints
│   │   │   └── UserAuthenticationProvider.java  # Custom authentication provider
│   │   ├── exception/                           # Custom exceptions
│   │   │   ├── ResourceNotFoundException.java   # 404 errors
│   │   │   ├── DuplicateEmailException.java     # 409 errors
│   │   │   ├── ServiceUnavailableException.java # 503 errors
│   │   │   └── GlobalExceptionHandler.java      # @ControllerAdvice for error handling
│   │   └── filter/                              # Request filters
│   │       └── FeatureFlagFilter.java           # Feature flag enforcement filter
│   └── resources/
│       ├── application.properties               # Application configuration
│       ├── application-dev.properties           # Development profile
│       ├── application-prod.properties          # Production profile
│       ├── openapi/                             # OpenAPI specifications
│       │   └── user-management-api.yaml         # Copied from specs/*/contracts/
│       └── db/migration/                        # Flyway migrations
│           ├── V001__create_users_table.sql
│           ├── V002__create_roles_table.sql
│           └── V003__create_user_roles_table.sql

├── test/
│   └── java/com/specdriven/
│       ├── SpecDrivenApplicationTests.java      # Application context loads test
│       ├── controller/                          # Controller layer tests
│       │   ├── HealthControllerTest.java        # Health check tests
│       │   ├── AuthControllerTest.java          # Login tests
│       │   ├── UsersApiControllerTest.java      # User CRUD tests (@WebMvcTest)
│       │   └── RolesApiControllerTest.java      # Role assignment tests
│       ├── service/                             # Service layer tests
│       │   ├── UserServiceTest.java             # User business logic tests
│       │   ├── RoleServiceTest.java             # Role business logic tests
│       │   └── AuthServiceTest.java             # Authentication logic tests
│       ├── repository/                          # Repository layer tests
│       │   ├── UserRepositoryTest.java          # User repo tests (@DataJdbcTest)
│       │   ├── RoleRepositoryTest.java          # Role repo tests
│       │   └── UserRoleRepositoryTest.java      # UserRole repo tests
│       ├── integration/                         # Integration tests
│       │   ├── UserManagementIntegrationTest.java   # Full user lifecycle tests
│       │   ├── AuthenticationIntegrationTest.java   # Authentication flow tests
│       │   ├── RoleManagementIntegrationTest.java   # Role assignment tests
│       │   ├── FeatureFlagIntegrationTest.java      # Feature flag behavior tests
│       │   └── ErrorHandlingIntegrationTest.java    # Error response tests
│       ├── security/                            # Security component tests
│       │   ├── JwtTokenProviderTest.java        # JWT token tests
│       │   └── JwtAuthenticationFilterTest.java # JWT filter tests
│       └── mapper/                              # Mapper tests
│           ├── UserMapperTest.java              # User mapping tests
│           └── RoleMapperTest.java              # Role mapping tests

build/
├── generated/                                   # Generated code (not committed)
│   └── openapi/
│       └── src/main/java/
│           └── com/specdriven/api/              # Generated API interfaces and models
│               ├── UsersApi.java                # Generated Users API interface
│               ├── RolesApi.java                # Generated Roles API interface
│               ├── model/                       # Generated DTOs
│               │   ├── CreateUserRequest.java
│               │   ├── UpdateUserRequest.java
│               │   ├── UserResponse.java
│               │   ├── PagedUserResponse.java
│               │   ├── LoginRequest.java
│               │   ├── LoginResponse.java
│               │   ├── ErrorResponse.java
│               │   └── HealthResponse.java
│               └── ... (other generated files)
└── ... (other build artifacts)
```

**Structure Decision**: Single Spring Boot web application (backend REST API)

This is a single-service monolithic application following standard Spring Boot conventions:
- **src/main/java**: Production code organized by layer (controller, service, repository, entity, etc.)
- **src/main/resources**: Configuration, migrations, and OpenAPI spec
- **src/test/java**: Test code organized by type (unit tests, integration tests)
- **build/generated**: OpenAPI-generated code (not committed, generated during build)

The structure supports:
- Clear separation of concerns (controller → service → repository)
- OpenAPI-first workflow (generated interfaces implemented by controllers)
- Comprehensive testing at all layers
- Spring Boot conventions for easy navigation and maintenance
- Feature flagging via filter layer
- Centralized error handling via @ControllerAdvice

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**No violations**: This plan fully complies with all constitution principles. No complexity tracking needed.
